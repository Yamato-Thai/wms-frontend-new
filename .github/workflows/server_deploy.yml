# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: server_deploy

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Angular
        run: npm run build -- --configuration production

      - name: Backup old IIS files with timestamp
        shell: powershell
        run: |
          $webRoot   = "C:\inetpub\wwwroot\WMS_Pro"
          $backupDir = "C:\inetpub\wwwroot\WMS_Pro_Backup"
          $timestamp = Get-Date -Format "yyyy-MM-dd-HHmm"
          $currentBackup = Join-Path $backupDir $timestamp

          Write-Output "Preparing backup..."
          if (-Not (Test-Path $backupDir)) {
            New-Item -ItemType Directory -Path $backupDir | Out-Null
            Write-Output "Backup root folder created: $backupDir"
          }

          if (Test-Path $webRoot) {
            New-Item -ItemType Directory -Path $currentBackup | Out-Null
            Copy-Item -Path (Join-Path $webRoot '*') -Destination $currentBackup -Recurse -Force
            Write-Output "Old web files copied to backup folder: $currentBackup"
          } else {
            Write-Output "Web root does not exist: $webRoot"
          }

      - name: Deploy new build to IIS (exclude web.config)
        shell: powershell
        run: |
          $source = "dist\wms-frontend-new\browser\*"
          $destination = "C:\inetpub\wwwroot\WMS_Pro"

          Write-Output "Deploying new build (without web.config)..."
          Get-ChildItem $source -Recurse | ForEach-Object {
            if ($_.Name -ne "web.config") {
              $destPath = Join-Path $destination ($_.FullName.Substring($source.Length).TrimStart('\'))
              if (-Not (Test-Path (Split-Path $destPath))) {
                New-Item -ItemType Directory -Force -Path (Split-Path $destPath) | Out-Null
              }
              Copy-Item $_.FullName -Destination $destPath -Force
            }
          }
          Write-Output "New build deployed to $destination (web.config preserved)."

      - name: Restart IIS site
        shell: powershell
        run: |
          Import-Module WebAdministration
          Restart-WebAppPool -Name "WMS PRO"
          Restart-WebItem 'IIS:\Sites\WMS PRO'
          Write-Output "IIS site 'WMS PRO' restarted successfully."

